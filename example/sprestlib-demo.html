<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="utf-8">
	<meta name="author"      content="https://github.com/gitbrent/">
	<meta name="website"     content="https://github.com/gitbrent/SpRestLib/">
	<meta name="keywords"    content="SpRestLib, JavaScript, js-sharepoint, OData, REST, SharePoint 2013, SP2013, SharePoint 2016, SP2016, SharePoint Online">
	<meta name="description" content="Content Editor WebPart to showcase SpRestLib features and capabilities">
	<meta name="revised"     content="Feb 23, 2017">

	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:700">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.0/gh-fork-ribbon.min.css">

	<!-- HOWTO / FAQ / SETUP -->
	<!--
		FAQ:
		*** This pages JavaScript requires a browser that supports ES6/JS2015 (IE11 wont work, sorry. sprLib does support it though!) ***

		SETUP:
		1) Create new folder under ./SiteAssets: "sprestlib"
		2) Drag the contents of the `/example` folder from the SpRestLib download archive into the ./SiteAssets/sprestlib folder (1 html file, 1 css folder and 1 js folder)
		3) Create a new Page: DEMO_SpRestLib.aspx
		4) Add a Content Editor Web Part to the page and point it to ./SiteAssets/sprestlib/sprestlib-demo.html
		5) The DEMO_SpRestLib.aspx page is ready to go!
	-->

	<link rel="stylesheet" type="text/css" href="../SiteAssets/sprestlib/css/tablesorter.css">
	<link rel="stylesheet" type="text/css" href="../SiteAssets/sprestlib/css/sprestlib.css">
	<link rel="stylesheet" type="text/css" href="../SiteAssets/sprestlib/css/sprestlib-demo.css">

	<!--
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	-->
	<script type="text/javascript" src="../SiteAssets/sprestlib/js/jquery.min.js"></script>
	<script type="text/javascript" src="../SiteAssets/sprestlib/js/jquery.tablesorter.min.js"></script>
	<script type="text/javascript" src="../SiteAssets/sprestlib/js/sprestlib.js"></script>
	<script type="text/javascript" src="../SiteAssets/sprestlib/js/ascii-table.min.js"></script>

	<script type="text/javascript">
		var HTML_SPINNER = '<div class="sprlib-spinner"><div class="sprlib-bounce1"></div><div class="sprlib-bounce2"></div><div class="sprlib-bounce3"></div></div>';

		// ==================================================================================================================

		function doInsertTest() {
			sprLib.list('Employees').insert({
				jsonData: {
					__metadata: { type:"SP.Data."+ 'Employees' +"ListItem" },
					Name: 'Mr. SP REST Library',
					Badge_x0020_Number: 123,
					Hire_x0020_Date: new Date(),
					Salary: 12345.49,
					Utilization_x0020_Pct: 1.0,
					Extension: 1234,
					Comments: 'New employee created',
					//Debug_x0020_FieldWillFail: true,
					Active_x003f_: true
				},
				onDone: function(newObj){ alert('insert done! new id = '+newObj.id); },
				onFail: function(errMsg){ console.error('ERROR: '+errMsg); }
			});
		}

		function doUpdateTest() {
			sprLib.model('Employees').syncItem({
				id      : $('#itemId').val(),
				jsonData: sprLib.model('Employees').parseForm('formUpdate').jsonSpData,
				onFail  : function(mesg){ console.error('doUpdateTest: '+mesg); },
				onDone  : function(data){ console.log('doUpdateTest done'); }
			});
		}

		// ==================================================================================================================

		function handleListChange() {
			// A: Clear results
			$('#tab1-ListInfo table').remove();
			$('#tab1-ListCols table').remove();
			// B: Return if nothing selected
			if ( !$('#selSiteLists').val() ) return;

			// LIST INFO:
			$('#tab1-ListInfo .divCode').text( 'sprLib.list(\''+ $('#selSiteLists').val() +'\').info()' );
			sprLib.list($('#selSiteLists').val()).info()
			.then(function(objInfo){
				var $table = $('<table><tbody></tbody></table>');
				Object.keys(objInfo).forEach(function(key,idx){
					//$table.find('thead tr').append('<th>'+ key +'</th>');
					$table.find('tbody').append('<tr><th>'+ key +'</th>'+'<td>'+ objInfo[key] +'</td></tr>');
				});
				$('#tab1-ListInfo .divCode').after( $table );
			})
			.catch(function(errMsg){
				$('$tab1-ListInfo .tableRows').after( '<table><tbody><tr><td>'+errMsg+'</td></tr></tbody></table>' );
			});

			// LIST COLS:
			$('#tab1-ListCols .divCode').text( 'sprLib.list(\''+ $('#selSiteLists').val() +'\').cols()' );
			sprLib.list($('#selSiteLists').val()).cols()
			.then(function(arrColObjs){
				var $table = $('<table><thead><tr></tr></thead><tbody></tbody></table>');

				if ( arrColObjs.length ) $.each(arrColObjs[0],function(key,val){ $table.find('thead tr').append('<th>'+key+'</th>') });

				arrColObjs.forEach(function(obj,idx){
					let $row = $('<tr/>');
					$.each(obj,function(key,val){ $row.append('<td>'+val+'</td>') });
					$table.find('tbody').append( $row );
				});

				$('#tab1-ListCols .divCode').after( $table );
			})
			.catch(function(errMsg){
				$('$tab1-ListCols .tableRows').after( '<table><tbody><tr><td>'+errMsg+'</td></tr></tbody></table>' );
			});
		}

		// ==================================================================================================================

		function execCodeAndShowResults(eleCode, eleData) {
			// A:
			$('#'+eleData).html( HTML_SPINNER );

			// B:
			Promise.resolve()
			.then(function(){ return eval( $('#'+eleCode).text() ) })
			.then(function(arrItems){
				var table = new AsciiTable();

				// DEBUG
				//console.log('execSandboxCode() => arrItems:'); console.table(arrItems); console.log('==============================\n');

				if (arrItems && arrItems.length > 0) table.setHeading( Object.keys(arrItems[0]) );
				$.each(arrItems, function(idx,obj){
					let vals = [];
					$.each(obj, function(key,val){ vals.push(val || '') });
					table.addRow(vals);
				});

				// Show
				$('#'+eleData).html( (arrItems && arrItems.length > 0 ? table.toString() : '(No results)') );
			})
			.catch(function(strErr){
				$('#'+eleData).html( '<h2 style="color:red">ERROR</h2>'+strErr );
			});
		}

		function doPageLoad() {
			// STEP 1: HTML Setup
			document.title = "SpRestLib - JavaScript Library for SharePoint Web Services";

			// STEP 2: Populate SETUP Tab

			// A: jQuery
			if ( typeof jQuery !== 'undefined' ) {
				$('#libChkJquery').append( '<div class="iconYes"></div>' );
			}
			else {
				$('#libChkJquery').append( 'oops - go check <script> tag ' );
			}

			// B: sprLib
			if ( typeof sprLib !== 'undefined' ) {
				$('#libChkSprLib').append( '<div class="iconYes"></div>' );
				var baseUrl = sprLib.baseUrl();

				// Make human readable when relative directory returned
				if ( baseUrl == ".." ) {
					baseUrl = location.href.substring(0, location.href.lastIndexOf('/'));
					baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf('/'));

					$('#spVersion').text( sprLib.version() );
				}
				$('#spBaseUrl').text( baseUrl );
			}
			else {
				$('#libChkSprLib').append( '<div class="iconFail"></div><br>oops - go check <script> tag ' );
				$('#spBaseUrl').text( '(n/a)' );

				// Halt execution
				return;
			}

			// TAB 1:
			// Populate <select> with List names
			sprLib.rest({ restUrl:'/_api/web/lists/' })
			.then(function(arrayListObjs){
				arrayListObjs
				.sort(function(a,b){return (a.Title > b.Title) ? 1 : ((b.Title > a.Title) ? -1 : 0);} )
				.forEach(function(obj,idx){
					if ( !obj.Hidden ) $('#selSiteLists').append('<option value="'+ obj.Title +'">'+ obj.Title +'</option>');
				});
				$('#contListSelect .sprlib-spinner').remove();
			});



			// STEP 2: Fill tab code and/or Populate Results of queries

			// TAB 1: List CRUD
			$('#tab1Code1').html("sprLib.list('Employees')\n"
				+ ".getItems({\n"
				+ "    listCols: ['Name', 'Badge_x0020_Number']\n"
				+ "})\n"
				+ ".then(function(arrData){ return arrData })\n"
				+ ".catch(function(errStr){ throw new Error(errStr) });"
			);

			// TAB 2: User/Group
			$('.testGroup > div > div:first-child span').each(function(i,tab){ $(this).text(i+1); });
			$('.testGroup > div .divTableRows').each(function(i,tab){
				$(tab).find('.boxCode').prop('id', 'tst'+(i+1));
				$(tab).find('.boxData').prop('id', 'res'+(i+1));
			});

			$('#tst1').html("sprLib.user().info()\n"
				+ ".then(function(objUser){\n"
				+ "    $.each(objUser,function(key,val){\n"
				+ "        if (typeof val !== 'object') $('#res1').append('&lt;span&gt;'+ key +':&lt;br&gt;*&nbsp;'+ val +'&lt;/span&gt;');\n"
				+ "    });\n"
				+ '});'
			);
			$('#tst2').html('sprLib.user().groups() <br>'
				+ '.then(function(arrGroups){ <br>'
				+ "    $.each(arrGroups,function(idx,objGroup){ $('#res2').append('&lt;span&gt;'+ objGroup.Title +'&lt;/span&gt;') }); <br>"
				+ '});'
			);

			$('#sandboxCode').html("sprLib.list('Employees')\n"
				+ ".getItems({\n"
				+ "  listCols:    ['Name','Hire_x0020_Date','Comments','Versioned_x0020_Comments'],\n"
				+ "  //queryFilter: 'Id eq 66',\n"
				+ "  fetchAppend: true\n"
				+ "})\n"
				+ ".then(function(arrData){ return arrData })\n"
				+ ".catch(function(errStr){ throw new Error(errStr) });"
			);

			// STEP 3: SPRLIB examples
			sprLib.list('Employees').getItems({
				listCols: {
					id:       { dataName:'ID' },
					name:     { dataName:'Name' },
					badgeNum: { dataName:'Badge_x0020_Number' },
					hireDate: { dataName:'Hire_x0020_Date', dispName:'Hire Date', dateFormat:'INTL' },
					salary:   { dataName:'Salary' },
					extn:     { dataName:'Extension' },
					utilPct:  { dataName:'Utilization_x0020_Pct', dispName:'Util %' },
					comments: { dataName:'Comments' }
				},
				queryMaxItems: "10"
			})
			.then(function(arrData){ console.log('Employees getItems done -> array length:'+arrData.length); })
			.catch(function(errMsg){ console.error('ERROR:'+errMsg); });

			sprLib.user().info().then(function(objUser){ $('#currUserName').text( objUser.Title ) });

			sprLib.user().info().then(function(objUser){
				$('#currUserId').text( objUser.Id );
				$('#currUserName').text( objUser.Title );
				$('#currUserEmail').text( objUser.Email );
			});

			sprLib.user().groups().then(function(arrGroups){ $('#currUserGroups').text( arrGroups.toString() ); });

			// STEP 4: Execute code
			$('#demoBody code').each(function(i,code){ eval( $(this).text() ); });
		}

		// ==================================================================================================================
		$(document).ready(function(){ doPageLoad(); });
	</script>
</head>
<body>
	<a class="github-fork-ribbon" href="https://github.com/GitBrent/SpRestLib" title="Fork me on GitHub">Fork me on GitHub</a>

	<div id="demoBody">
		<div class="bigTitle">SpRestLib :: Feature Demos</div>
		<div class="subTitle">JavaScript Library for SharePoint Web Services</div>

		<div id="navTabs" class="modernTabs">
			<ul>
				<li class="active" onclick="$('#navTabs').find('> div, li').removeClass('active'); $(this).addClass('active'); $('#tab0').addClass('active');">Setup</li><li onclick="$('#navTabs').find('> div, li').removeClass('active'); $(this).addClass('active'); $('#tab1').addClass('active');">List Get / CRUD</li><li onclick="$('#navTabs').find('> div, li').removeClass('active'); $(this).addClass('active'); $('#tab2').addClass('active');">User Info</li><li onclick="$('#navTabs').find('> div, li').removeClass('active'); $(this).addClass('active'); $('#tab3').addClass('active');">HTML Form Population</li><li onclick="$('#navTabs').find('> div, li').removeClass('active'); $(this).addClass('active'); $('#tab4').addClass('active');">REST API Calls</li><li onclick="$('#navTabs').find('> div, li').removeClass('active'); $(this).addClass('active'); $('#tab5').addClass('active');">Code Sandbox</li>
			</ul>

			<div id="tab0" data-tab="Setup" class="active">
				<div class="subTitle">Welcome!</div>
				<p>
					Let's check your setup and show you how SpRestLib is configured. If everything below looks okay, then
					all the functionality in the demo tabs are ready to explore.<br>
					<br>
					&bull;&nbsp;Please check the <a href="https://github.com/gitbrent/SpRestLib">GitHub Project Site</a>
					for setup and configuration FAQs and full documentation.
				</p>

				<div class="divTable">
					<div data-name="col1" style="width:33%">
						<div class="subTitle">JavaScript Library Check</div>
						<div class="divTableRows">
							<div>
								<div id="libChkJquery"></div><div>jQuery loaded?</div>
							</div>
							<div>
								<div id="libChkSprLib"></div><div>sprLib loaded?</div>
							</div>
						</div>
					</div>
					<div data-name="col2" style="width:67%">
						<div class="subTitle">SharePoint Environment / Configuration</div>
						<div class="divTableRows">
							<div>
								<div><div class="iconInfo"></div></div><div>SpRestLib Base URL</div><div id="spBaseUrl"></div>
							</div>
							<div>
								<div><div class="iconInfo"></div></div><div>SpRestLib Version</div><div id="spVersion">?</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div id="tab1" data-tab="List CRUD">
				<div class="subTitle">List/Library Methods</div>
				<p>
					Here are all the Lists/Libraries found on this site:<br>
					Select one and try some CRUD ops!
				</p>

				<div id="contListSelect" class="divTable" style="width:auto; margin-bottom:20px;">
					<div class="th">
						Site Lists/Libraries
					</div>
					<div>
						<div class="sprlib-spinner"><div class="sprlib-bounce1"></div><div class="sprlib-bounce2"></div><div class="sprlib-bounce3"></div></div>
						<select id="selSiteLists" onchange="handleListChange()"></select>
						<span>(only non-hidden Lists/Libraries are shown)</span>
					</div>
				</div>

				<div id="tab1-ListInfo" style="margin-bottom:20px;">
					<div class="subTitle">List Information</div>
					<div class="divCode">sprLib.list('listName').info()</div>
				</div>

				<div id="tab1-ListCols" style="margin-bottom:20px;">
					<div class="subTitle">List Columns</div>
					<div class="divCode">sprLib.list('listName').cols()</div>
				</div>

				<!--
				<div class="divTableRows">
					<div class="row"><div>INPUT </div><div class="boxCode" id="tst1"></div></div>
					<div class="row"><div>OUTPUT</div><div class="boxData" id="res1"></div></div>
				</div>
				-->

				<!-- OLD
				<div id="tab1Code1" class="boxCode"></div>
				<div style="text-align:center; padding:10px; margin:20px 0;">
					<button type="button" class="flatBtn flatBtn-blue" onclick="execCodeAndShowResults('tab1Code1','tab1Data1')">SIMPLE TEST</button>
				</div>
				<div id="tab1Data1" class="boxData"></div>
				-->

				<!-- TODO: core API calls: eg: _/api/webs -->
			</div>

			<div id="tab2" data-tab="Users">
				<div class="subTitle">User Methods</div>
				<div id="tabUsersGroups" class="divTableRows testGroup" style="margin-top:0">
					<div class="row">
						<div>Current User<br>Info</div>
						<div>
							<div class="divTableRows">
								<div class="row"><div>INPUT </div><div class="boxCode"></div></div>
								<div class="row"><div>OUTPUT</div><div class="boxData"></div></div>
							</div>
						</div>
					</div>
					<div class="row">
						<div>Current User<br>Groups</div>
						<div>
							<div class="divTableRows">
								<div class="row"><div>INPUT </div><div class="boxCode"></div></div>
								<div class="row"><div>OUTPUT</div><div class="boxData"></div></div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div id="tab3" dats-tab="Data Binding">
				<div class="subTitle" onclick="$(this).next('div').toggle('slow'); $(this).find('.arrow').toggleClass('active');" title="Click to Show/Hide">
					<div class="arrow active"></div>HTML Form Binding/Population
				</div>
				<div id="tabHtmlElements" class="divTableRows testGroup">
					<div>
						<div class="subTitle">EX: Populate <kbd>&lt;span&gt;</kbd></div>
						Employee #1: <b><span data-sprlib='{ "list":"Employees", "value":"Name", "filter":{"col":"Name", "op":"eq", "val":"Brent Ely"} }'></span></b>
					</div>
					<div>
						<div class="subTitle">EX: Populate &lt;select&gt;</div>
						<select id="selTest1" data-sprlib='{ "list":"Employees", "value":"Id",   "text":"Name" }'></select>
						<select id="selTest2" data-sprlib='{ "list":"Employees", "value":"Name", "text":"Name" }'></select>
					</div>
					<div>
						<div class="subTitle">EX: Unknown Model</div>
						<input type="text" data-sprlib='{ "list":"Departments", "value":"Title" }' placeholder="Departments.Title"></input>
						<input type="text" data-TODO='{ "list":"ListDoesntExistTest", "value":"Name" }' placeholder="(Negative Test)"></input>
					</div>
				</div>

				<div class="subTitle" onclick="$(this).next('div').toggle('slow'); $(this).find('.arrow').toggleClass('active');" title="Click to Show/Hide">
					<div class="arrow active"></div>EX: table-foreach
				</div>
				<div>
					<table data-sprlib='{ "list":"Departments", "cols":["Id","Title"], "showBusy":true }'></table>
					<table data-sprlib='{ "list":"Departments", "cols":["Title","Modified"], "showBusy":true }'></table>
				</div>

				<div class="subTitle" onclick="$(this).next('div').toggle('slow'); $(this).find('.arrow').toggleClass('active');" title="Click to Show/Hide">
					<div class="arrow active"></div>EX: tbody-foreach
				</div>
				<div>
					<table border="0" cellpadding="0" cellspacing="0">
						<thead>
							<tr><th>Emp ID</th><th>Employee Name</th><th>Badge #</th></tr>
						</thead>
						<tbody data-sprlib='{ "list":"Employees", "cols":["Id","Name","Badge_x0020_Number"], "showBusy":true }'></tbody>
					</table>
				</div>
			</div>

			<div id="tab4" data-tab="RESR API">
				<div class="subTitle" onclick="$(this).next('div').toggle('slow'); $(this).find('.arrow').toggleClass('active');" title="Click to Show/Hide">
					<div class="arrow active"></div>REST API Calls
				</div>
			</div>

			<div id="tab5" data-tab="Code Sandbox">
				<div id="sandboxMessage">Code below is editable</div>
				<div id="sandboxCode" class="boxCode" contenteditable="true"></div>
				<div style="text-align:center; padding:10px; margin:20px 0;">
					<button type="button" class="flatBtn flatBtn-green" onclick="execCodeAndShowResults('sandboxCode','sandboxData')">Execute Sandbox Code</button>
				</div>
				<div id="sandboxData" class="boxData"></div>
			</div>
		</div>
	</div>
</body>
</html>
